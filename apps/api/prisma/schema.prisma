generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model OwnerUser {
  id                  Int                  @id @default(autoincrement())
  email               String               @unique
  password            String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime?            @updatedAt
  cnpj                String?              @db.Char(14)
  cpf                 String?              @db.Char(11)
  refreshToken        String?
  barberShop          BarberShop?
  passwordResetTokens PasswordResetToken[]

  @@index([cpf])
  @@index([cnpj])
  @@index([createdAt])
  @@map("owner_users")
}

model BarberUser {
  id                  Int                  @id @default(autoincrement())
  userName            String               @unique
  phoneNumber         BigInt?
  password            String
  createdAt           DateTime             @default(now())
  barberShop          BarberShop?          @relation(fields: [barberShopId], references: [id])
  barberShopId        Int
  appointments        Appointment[]
  passwordResetTokens PasswordResetToken[]

  @@map("barber_users")
}

model CustomerUser {
  id           Int           @id @default(autoincrement())
  userName     String
  phoneNumber  BigInt        @unique
  createdAt    DateTime      @default(now())
  appointments Appointment[]
  barberShop   BarberShop?   @relation(fields: [barberShopId], references: [id])
  barberShopId Int?

  @@map("customer_users")
}

model BarberShop {
  id             Int       @id @default(autoincrement())
  userId         Int       @unique
  user           OwnerUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  barbershopName String?
  slug           String
  phoneNumber    BigInt?   @unique
  address        String?
  logoUrl        String?
  bannerUrl      String?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime? @updatedAt

  services      Service[]
  openingHours  OpeningHour[]
  appointments  Appointment[]
  customerUsers CustomerUser[]
  barberUsers   BarberUser[]

  @@index([isActive])
  @@index([createdAt])
  @@map("barbershops")
}

model OpeningHour {
  barbershopId Int
  barbershop   BarberShop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  day          WeekDay
  isOpen       Boolean    @default(false)
  timeRanges   Json?

  @@id([barbershopId, day])
  @@map("opening_hours")
}

model PasswordResetToken {
  id           Int         @id @default(autoincrement())
  token        String      @unique
  userType     UserType  
  ownerId      Int?
  owner        OwnerUser?  @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  barberId     Int?
  barber       BarberUser? @relation(fields: [barberId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime    @default(now())
  usedAt       DateTime?   

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Service {
  id           Int           @id @default(autoincrement())
  name         String        @db.VarChar(100)
  image        String?
  barbershopId Int
  barbershop   BarberShop    @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  description  String?
  duration     Int
  appointments Appointment[]
  createdAt    DateTime      @default(now())
  isActive     Boolean       @default(true)

  @@map("services")
}

model Appointment {
  id             Int               @id @default(autoincrement())
  barberShop     BarberShop        @relation(fields: [barberShopId], references: [id], map: "fk_appointment_barbershop")
  barberShopId   Int
  customerUserId Int
  customerUser   CustomerUser      @relation(fields: [customerUserId], references: [id])
  serviceId      Int
  service        Service           @relation(fields: [serviceId], references: [id])
  notes          String?
  barberUser     BarberUser?       @relation(fields: [barberUserId], references: [id])
  barberUserId   Int?
  status         AppointmentStatus @default(agendado)
  date           DateTime
  createdAt      DateTime          @default(now())

  @@map("appointments")
}

enum UserType {
  owner
  barber
}

enum WeekDay {
  segunda
  terca
  quarta
  quinta
  sexta
  sabado
  domingo
}

enum PaymentMethod {
  dinheiro
  cartao
  pix
}

enum AppointmentStatus {
  agendado
  finalizado
  cancelado_pelo_cliente
  cancelado_pela_barbearia
}
